var Kaya=window.Kaya=function(){};Kaya.version="0.0.1",Kaya.debug=!0;var uniqueIdNumber=0;Kaya.uniqueId=function(){return++uniqueIdNumber},Kaya.Utilities={extend:function(t){var i=Array.prototype.slice.call(arguments,1);return i.forEach(function(i){if(i)for(var e in i)t[e]=i[e]}),t},clone:function(t){if("object"!=typeof t)return t;var i;if(t instanceof Date)return i=new Date,i.setTime(t.getTime()),i;if(t instanceof Array)return i=Array.prototype.slice.call(t);if(t instanceof Object)return i=Kaya.Utilities.extend({},t);throw new Error("Failed to clone an object.")},hexToRgb:function(t){var i=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(i,function(t,i,e,n){return i+i+e+e+n+n});var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},rgbToHex:function(t,i,e){function n(t){t>255&&(t=255);var i=t.toString(16);return 1==i.length?"0"+i:i}return"#"+n(t)+n(i)+n(e)},bezier:function(t,i,e,n,a){var r=function(i){var n=1-i;return 3*n*n*i*t+3*n*i*i*e+i*i*i},s=function(t){var e=1-t;return 3*e*e*t*i+3*e*t*t*n+t*t*t};return function(t){var i,e,n,o,h=t;if(i=0,e=1,n=h,i>n)return s(i);if(n>e)return s(e);for(;e>i;){if(o=r(n),Math.abs(o-h)<a)return s(n);h>o?i=n:e=n,n=.5*(e-i)+i}return s(n)}},shuffle:function(t){for(var i,e,n=t.length;n;i=parseInt(Math.random()*n),e=t[--n],t[n]=t[i],t[i]=e);return t}},Kaya.Class=function(){},Kaya.Class.extend=function(t){function i(){this.constructor&&this.constructor.apply(this,arguments)}var e=this.prototype,n=Object.create(this.prototype);for(var a in t)t.hasOwnProperty(a)&&(n[a]="function"==typeof t[a]?function(t,i){return function(){this._super=e[t];var n=i.apply(this,arguments);return delete this._super,n}}(a,t[a]):t[a]);return i.prototype=n,i.constructor=i,i.extend=Kaya.Class.extend,i},Kaya.Object=Kaya.Class.extend({constructor:function(t){this._events=[];for(var i in t)this[i]=t[i];this.initialize&&this.initialize(),this.trigger("initialized")},on:function(t,i){this._events[t]=this._events[t]||[],this._events[t].push(i)},off:function(t,i){if(this._events[t]){var e=this._events[t].indexOf(i);this._events[t].splice(e,1)}},trigger:function(){var t=Array.prototype.slice.call(arguments);t.splice(0,1);var i=this._events[arguments[0]];i&&i.forEach(function(i){i.apply(this,t)})}}),Kaya.Resource=Kaya.Object.extend({initialize:function(){var t=this;this.ready=!1,this.on("ready",function(){t.ready=!0})},load:function(){}}),Kaya.Resource.Image=Kaya.Resource.extend({load:function(){var t=this;this.image=new Image,this.image.onload=function(){t.trigger("ready")},this.image.src=this.src}}),Kaya.ResourceLoader=Kaya.Object.extend({initialize:function(){if(!this.list)throw new Error("No resource list specified.");this.size=this.list.length,this.progress=0},load:function(){var t=this;this.list.forEach(function(i){i.on("ready",function(){t.progress+=1,t.trigger("progress",t.progress,t.size),t.progress===t.size&&t.trigger("ready")}),i.load()})}}),Kaya.App=Kaya.Object.extend({initialize:function(){if(!this.documentObject)throw new Error("No app frame is specified.");if(this._DOM=document.querySelector(this.documentObject),null===this._DOM)throw new Error("App document object is not found.");this.size=this.size||{},this.size.width=this.size.width||400,this.size.height=this.size.height||300,this._DOM.style.backgroundColor=this.background||"#000000",this._DOM.style.width=this.size.width+"px",this._DOM.style.height=this.size.height+"px",this._canvas=document.createElement("canvas"),this._canvas.width=this.size.width,this._canvas.height=this.size.height,this._DOM.appendChild(this._canvas),this._context=this._canvas.getContext("2d");var t=this,i=(new Date).getTime(),e=function(){var n=(new Date).getTime(),a=n-i;i=n,t.trigger("refresh",a),window.requestAnimationFrame(e,t._DOM)};if(e(),Kaya.debug){var n=document.querySelector("#fps"),a=function(t){n.innerHTML=Math.round(1e3/t)};this.on("refresh",a)}},runStage:function(t){this._currentStage&&t.trigger("leave"),this._currentStage=t,t._app=this,t.trigger("enter")}}),Kaya.Stage=Kaya.Object.extend({initialize:function(){var t=this;this.sprites=this.sprites||[];var i=function(){t._app._context.clearRect(0,0,t._app.size.width,t._app.size.width),t.sprites.forEach(function(i){i.renderWrapper(t._app._context,t._app.size.width,t._app.size.height)})},e=function(){t._app.on("refresh",i)};this.on("enter",e);var n=function(){t._app.off("refresh",i)};this.on("leave",n)}}),Kaya.Sprite=Kaya.Object.extend({renderWrapper:function(t,i,e){this.lazyRender?this.rerender||!this._lazyRenderCanvas?(this.translateAndRender(this.lazyRenderContext(i,e)),this.rerender=!1):t.drawImage(this._lazyRenderCanvas,0,0):this.translateAndRender(t)},translateAndRender:function(t){t.save(),(this.x||this.y)&&t.translate(this.x||0,this.y||0),this.rotate&&t.rotate(this.rotate),this.alpha&&(t.globalAlpha=this.alpha),this.render(t),t.restore()},lazyRenderContext:function(t,i){return this._lazyRenderCanvas||(this._lazyRenderCanvas=document.createElement("canvas"),this._lazyRenderCanvas.width=t,this._lazyRenderCanvas.height=i),this._lazyRenderCanvas.getContext("2d")},render:function(){},above:function(t,i){return 2*Math.abs(t)<=this.width&&2*Math.abs(i)<=this.height},aboveOnCanvas:function(){}}),Kaya.Sprite.Rectangle=Kaya.Sprite.extend({render:function(t){t.fillStyle="rgb("+this.color.r+","+this.color.g+","+this.color.b+")",t.fillRect(-this.width/2,-this.height/2,this.width,this.width)}}),Kaya.Sprite.Image=Kaya.Sprite.extend({render:function(t){t.drawImage(this.image.image,-this.width/2,-this.height/2,this.width,this.height)}}),Kaya.Sprite.SpriteSheet=Kaya.Sprite.extend({render:function(t){t.drawImage(this.image.image,-this.width/2,-this.height/2,this.width,this.height)}}),Kaya.Action=Kaya.Object.extend({initialize:function(){},update:function(){},start:function(){this._updateFunction=this.update.bind(this),this.app.on("refresh",this._updateFunction)},pause:function(){this.app.off("refresh",this._updateFunction)}}),Kaya.Action.FiniteTime=Kaya.Action.extend({initialize:function(){if(this._super.apply(this,this.arguments),!this.duration)throw new Error("Duration is not defined for a finite action.");this._passTime=0},start:function(){var t=this;this._updateFunction=function(i){t._passTime+=i;var e=t._passTime/t.duration;e>=1&&(e=1,t.trigger("finish"),t.app.off("refresh",t._updateFunction)),t.update(e)}.bind(this),this.app.on("refresh",this._updateFunction)}}),Kaya.Action.LinearGradient=Kaya.Action.FiniteTime.extend({initialize:function(){if(this._super.apply(this,this.arguments),!this.sprite)throw new Error("Sprite is not defined")},update:function(t){for(var i in this.list)this.sprite[i]=this.list[i].from+this.list[i].distance*t}}),Kaya.Action.Move=Kaya.Action.LinearGradient.extend({initialize:function(){this._super.apply(this,this.arguments),this.list={x:{from:this.sprite.x,distance:this.x},y:{from:this.sprite.y,distance:this.y}}}}),Kaya.Action.Rotate=Kaya.Action.LinearGradient.extend({initialize:function(){this._super.apply(this,this.arguments),this.list={rotate:{from:this.sprite.rotate||0,distance:this.rotate}}}}),Kaya.Action.Loop=Kaya.Action.extend({initialize:function(){if(this._super.apply(this,this.arguments),this.count=0,this.startAction(),!this.action)throw new Error("Action is not defined");this.app=this.action.app},startAction:function(){var t=this,i=new this.action;i.on("finish",function(){t.count+=1,console.log("here?"+t.count),(-1===t.times||t.count<t.times)&&(console.log("here?"),setTimeout(t.startAction.bind(t),0))}),i.start()}});